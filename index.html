<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDT Mining SekolahRakyat — Polygon (Demo + Optional Live)</title>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--text:#e8edff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1b2347,transparent),linear-gradient(180deg,#0b1020,#0b0f1a);color:var(--text)}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:linear-gradient(180deg,#141d3a,#0d1430);border:1px solid #2a3577;border-radius:16px;padding:16px;box-shadow:0 10px 30px #0007}
    .title{font-weight:700;font-size:20px;margin:0 0 8px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-size:13px;opacity:.95}
    input, select {background:#0b1330;border:1px solid #2a3577;color:var(--text);padding:10px 12px;border-radius:12px;outline:none;width:100%}
    .btn{appearance:none;border:1px solid #3451b2;background:#12205a;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .02s ease,filter .2s}
    .btn[disabled]{opacity:.5;cursor:not-allowed;filter:grayscale(.2)}
    .btn.primary{background:linear-gradient(180deg,#2a55ff,#1631a1);border-color:#5873ff}
    .btn.ok{background:linear-gradient(180deg,#1f8a5a,#156d46);border-color:#36d399}
    .btn.warn{background:linear-gradient(180deg,#a8741f,#7a560f);border-color:#fbbf24}
    .btn.err{background:linear-gradient(180deg,#8a1f2e,#6d1524);border-color:#f87171}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .pill{background:#0b1330;border:1px solid #2a3577;border-radius:12px;padding:10px 12px}
    .log{height:180px;overflow:auto;background:#060a1a;border:1px solid #263071;border-radius:12px;padding:10px;font-size:12px;white-space:pre-line}
    .stat{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3577,transparent);margin:12px 0}
    small.muted{color:#9fb3ff99}
    .switch{display:flex;align-items:center;gap:8px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 8px">USDT "Mining" SekolahRakyat — Polygon</h1>
    <p class="foot" style="margin:0 0 14px">
      Default mode: <b>simulation only</b>. To enable real on-chain transfers toggle <b>Live Transfers</b> below (do not enable unless you accept real token + gas usage).
    </p>

    <div class="grid">
      <section class="card">
        <h2 class="title">Wallet & Network</h2>
        <div class="row">
          <button id="btnConnect" class="btn primary">Connect MetaMask</button>
          <div id="who" class="pill mono" style="min-width:280px">—</div>
        </div>

        <div class="stat">
          <div class="pill">USDT Balance: <b class="mono" id="usdtBal">—</b></div>
          <div class="pill">MATIC Balance: <b class="mono" id="maticBal">—</b></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnRefresh" class="btn">Refresh Balances</button>
          <button id="btnSwitch" class="btn">Switch to Polygon</button>
        </div>

        <div class="hr"></div>
        <div class="row">
          <label style="min-width:160px">Mode</label>
          <div class="switch">
            <input id="liveToggle" type="checkbox" />
            <label for="liveToggle">Enable Live Transfers</label>
          </div>
        </div>
        <small class="muted">If enabled, withdraw will attempt an on-chain USDT transfer from the connected wallet.</small>
      </section>

      <section class="card">
        <h2 class="title">Addresses</h2>
        <label for="target">Target address (deposit destination)</label>
        <input id="target" placeholder="0x… targetAddress" />
        <div style="height:8px"></div>
        <label for="payout">Payout address (withdraw destination)</label>
        <input id="payout" placeholder="0x… payoutAddress" />
        <div style="height:8px"></div>
        <small class="muted">Both must be valid Polygon addresses. Live transfers will use the connected wallet as `from`.</small>
      </section>

      <section class="card">
        <h2 class="title">Actions</h2>
        <div class="row">
          <button id="btnDeposit1" class="btn ok" disabled>Deposit 1 USDT (Sim)</button>
          <button id="btnStart" class="btn primary" disabled>Start Mining</button>
          <button id="btnStop" class="btn warn" disabled>Stop Mining</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnProfit" class="btn" disabled>Show Total Profit</button>
          <button id="btnWithdraw" class="btn err" disabled>Withdraw ALL Profit</button>
        </div>

        <div class="hr"></div>
        <div class="pill">Total Profit (simulated): <b id="profit" class="mono">0.000000</b> USDT</div>
        <small class="muted">Profit increases while mining (simulated). Withdraw will be simulated unless Live Transfers is enabled and funds are sufficient.</small>
      </section>

      <section class="card">
        <h2 class="title">Activity Log</h2>
        <div id="log" class="log"></div>
      </section>
    </div>

    <p class="foot" style="margin-top:14px">
      Token: <span class="mono">USDT (Polygon) — 0xc2132d05d31c914a87c6611c10748aeb04b58e8f</span><br>
      RPC: <span class="mono">https://polygon-rpc.com</span>
    </p>
  </div>

  <script>
  (function(){
    // ======= CONFIG =======
    const USDT_ADDRESS = "0xc2132d05d31c914a87c6611c10748aeb04b58e8f";
    const POLYGON = {
      chainId: "0x89",
      chainName: "Polygon Mainnet",
      rpcUrls: ["https://polygon-rpc.com"],
      nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
      blockExplorerUrls: ["https://polygonscan.com/"]
    };
    const ERC20_ABI = [
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint amount) returns (bool)"
    ];

    // ======= STATE =======
    let provider = null;
    let signer = null;
    let account = null;
    let tokenContract = null;     // provider-based contract (reads)
    let tokenWithSigner = null;   // signer-based contract (writes)
    let decimals = 6;
    let symbol = "USDT";

    let miningTimer = null;
    let profitUsdt = 0;
    const PROFIT_PER_SECOND = 0.005;

    // ======= HELPERS =======
    const $ = id => document.getElementById(id);
    const logEl = (msg) => {
      const t = new Date().toLocaleTimeString();
      const el = $("log");
      if (el) el.textContent = `[${t}] ${msg}\n` + el.textContent;
      console.log("[app]", msg);
    };
    const isLiveEnabled = () => !!$("liveToggle") && $("liveToggle").checked;

    function setButtonsEnabled(enabled){
      const ids = ["btnDeposit1","btnStart","btnStop","btnProfit","btnWithdraw"];
      for(const id of ids){
        const el = $(id);
        if(el) el.disabled = !enabled;
      }
      // always keep connect/refresh/switch available
      if($("btnConnect")) $("btnConnect").disabled = false;
      if($("btnSwitch")) $("btnSwitch").disabled = false;
      if($("btnRefresh")) $("btnRefresh").disabled = false;
    }

    function validateAddress(addr){
      try { ethers.utils.getAddress(addr); return true; }
      catch { return false; }
    }

    async function ensurePolygon(){
      const eth = window.ethereum;
      if(!eth) throw new Error("MetaMask not found");
      try {
        await eth.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON.chainId }] });
      } catch (err) {
        if (err && err.code === 4902) {
          await eth.request({ method: 'wallet_addEthereumChain', params: [POLYGON] });
        } else {
          throw err;
        }
      }
    }

    // ======= WALLET & BALANCE =======
    async function connect(){
      try {
        if (!window.ethereum) throw new Error("MetaMask not installed");
        await ensurePolygon();
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        $("who").textContent = account;
        tokenContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
        tokenWithSigner = tokenContract.connect(signer);
        decimals = await tokenContract.decimals().catch(()=>6);
        symbol = await tokenContract.symbol().catch(()=> "USDT");
        logEl("Connected: " + account);
        setButtonsEnabled(true);
        await refreshBalances();

        // add listeners once
        if(window.ethereum && !window.ethereum._my_listeners_added){
          window.ethereum.on("accountsChanged", handleAccountsChanged);
          window.ethereum.on("chainChanged", handleChainChanged);
          window.ethereum._my_listeners_added = true;
        }
      } catch (err) {
        console.error(err);
        logEl("Connect failed: " + (err && err.message ? err.message : err));
        alert("Connect failed: " + (err && err.message ? err.message : err));
        setButtonsEnabled(false);
      }
    }

    async function handleAccountsChanged(accounts){
      if(!accounts || accounts.length === 0){
        logEl("Wallet disconnected");
        account = null;
        signer = null;
        $("who").textContent = "—";
        setButtonsEnabled(false);
        $("usdtBal").textContent = "—";
        $("maticBal").textContent = "—";
      } else {
        account = accounts[0];
        signer = provider.getSigner();
        tokenWithSigner = tokenContract.connect(signer);
        $("who").textContent = account;
        logEl("Account changed: " + account);
        await refreshBalances();
      }
    }

    async function handleChainChanged(chainId){
      logEl("Chain changed: " + chainId + " — refreshing UI");
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      if(account){
        tokenContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
        tokenWithSigner = tokenContract.connect(provider.getSigner());
        await refreshBalances();
      } else {
        $("usdtBal").textContent = "—";
        $("maticBal").textContent = "—";
      }
    }

    async function refreshBalances(){
      if(!provider || !account){
        logEl("Not connected — cannot refresh balances");
        return;
      }
      try {
        const matic = await provider.getBalance(account);
        $("maticBal").textContent = ethers.utils.formatEther(matic).slice(0,10);

        if(tokenContract){
          const bal = await tokenContract.balanceOf(account);
          $("usdtBal").textContent = ethers.utils.formatUnits(bal, decimals).slice(0,12) + " " + symbol;
        } else {
          $("usdtBal").textContent = "—";
        }
        logEl("Balances refreshed");
      } catch (err) {
        console.error(err);
        logEl("Refresh failed: " + (err && err.message ? err.message : err));
      }
    }

    // ======= SIMULATED ACTIONS =======
    async function deposit1USDT(){
      if(!account){ alert("Connect wallet first"); return; }
      const target = $("target").value.trim();
      if(!validateAddress(target)) return alert("Enter valid target address");

      // read on-chain balance to warn user (simulation)
      try {
        if(tokenContract){
          const balRaw = await tokenContract.balanceOf(account);
          const bal = Number(ethers.utils.formatUnits(balRaw, decimals));
          if(bal < 1){
            if(!confirm("Your on-chain USDT balance appears less than 1 USDT. Continue simulation?")) return;
          }
        }
      } catch(e){ /* ignore read errors */ }

      logEl(`Simulated deposit: 1 ${symbol} -> ${target}`);
      alert("Deposit simulated (no real transaction sent).");
      await refreshBalances();
    }

    function startMining(){
      if(miningTimer){ logEl("Already mining"); return; }
      miningTimer = setInterval(()=>{
        profitUsdt += PROFIT_PER_SECOND;
        $("profit").textContent = profitUsdt.toFixed(6);
      }, 1000);
      logEl("Mining started (simulated)");
    }

    function stopMining(){
      if(miningTimer){ clearInterval(miningTimer); miningTimer = null; logEl("Mining stopped"); }
      else logEl("Mining not running");
    }

    function showProfit(){
      $("profit").textContent = profitUsdt.toFixed(6);
      logEl("Showing profit: " + profitUsdt.toFixed(6) + " " + symbol);
    }

    // ======= WITHDRAW (SIMULATED or LIVE with checks) =======
    async function withdrawAllProfit(){
      if(profitUsdt <= 0){ alert("No profit to withdraw"); return; }
      const to = $("payout").value.trim();
      if(!validateAddress(to)) return alert("Enter valid payout address");

      const amountStr = profitUsdt.toFixed(decimals); // e.g., "0.500000"
      const amountUnits = ethers.utils.parseUnits(amountStr, decimals); // BigNumber

      // If Live Transfers disabled -> simulate
      if(!isLiveEnabled()){
        logEl(`Simulated withdraw: ${amountStr} ${symbol} -> ${to}`);
        alert("Withdraw simulated (no real transaction sent).");
        profitUsdt = 0;
        $("profit").textContent = "0.000000";
        await refreshBalances();
        return;
      }

      // Live Transfers enabled: ensure connected and signer present
      if(!signer || !tokenWithSigner){
        alert("Wallet not connected for live transfers. Please connect first.");
        return;
      }

      try {
        // 1) read on-chain balance
        const balOnChain = await tokenContract.balanceOf(account);
        if(balOnChain.lt(amountUnits)){
          // not enough on-chain balance - refuse to send and fallback to simulation
          alert("Insufficient on-chain USDT balance for live transfer. Falling back to simulated withdraw.");
          logEl("Live withdraw aborted: insufficient on-chain balance. Performing simulated withdraw instead.");
          profitUsdt = 0;
          $("profit").textContent = "0.000000";
          await refreshBalances();
          return;
        }

        // 2) estimate gas (optional) and send
        logEl(`Attempting live withdraw: ${amountStr} ${symbol} -> ${to} (from ${account}). Confirm MetaMask popup.`);
        // tokenWithSigner uses signer to send
        const tx = await tokenWithSigner.transfer(to, amountUnits);
        logEl("Withdraw tx sent: " + tx.hash);
        // wait for confirmation
        await tx.wait();
        logEl("Withdraw confirmed: " + amountStr + " " + symbol + " -> " + to);
        alert("Withdraw successful on-chain. See tx: " + tx.hash);
        // reset profit counter
        profitUsdt = 0;
        $("profit").textContent = "0.000000";
        await refreshBalances();
      } catch (err) {
        console.error(err);
        // Inspect common revert reasons and provide friendly messages
        const msg = err && err.message ? err.message : String(err);
        logEl("Withdraw failed: " + msg);
        alert("Withdraw failed: " + (msg.length > 300 ? msg.slice(0,300)+"..." : msg));
        // Keep profit value intact so user can retry or choose simulated fallback
      }
    }

    // ======= WIRING =======
    document.addEventListener("DOMContentLoaded", function(){
      // disable action buttons until connected
      setButtonsEnabled(false);

      // buttons
      $("btnConnect").addEventListener("click", connect);
      $("btnRefresh").addEventListener("click", refreshBalances);
      $("btnSwitch").addEventListener("click", async ()=>{
        try { await ensurePolygon(); logEl("Requested switch to Polygon"); }
        catch(err){ logEl("Switch failed: "+(err && err.message ? err.message : err)); alert("Switch failed: " + (err && err.message ? err.message : err)); }
      });

      $("btnDeposit1").addEventListener("click", deposit1USDT);
      $("btnStart").addEventListener("click", startMining);
      $("btnStop").addEventListener("click", stopMining);
      $("btnProfit").addEventListener("click", showProfit);
      $("btnWithdraw").addEventListener("click", withdrawAllProfit);

      // small UX: if previously connected, try silent connect (won't prompt)
      if(window.ethereum){
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum, "any");
          provider.listAccounts().then(accs => {
            if(accs && accs.length) connect().catch(()=>{/*ignore*/});
          }).catch(()=>{/*ignore*/});
        } catch(e){
          // ignore
        }
      }

      logEl("UI ready. Click Connect MetaMask to begin. Live Transfers disabled by default.");
    });

    // Expose small helpers for debugging from console
    window._dapp = {
      withdrawAllProfit,
      simulateWithdraw: async ()=>{ $("liveToggle").checked = false; await withdrawAllProfit(); },
      enableLive: ()=>{ $("liveToggle").checked = true; },
      disableLive: ()=>{ $("liveToggle").checked = false; },
      getProfit: ()=>profitUsdt,
      addProfit: (x)=>{ profitUsdt += Number(x); $("profit").textContent = profitUsdt.toFixed(6); }
    };
  })();
  </script>
</body>
</html>


  })();
  </script>
</body>
</html>
