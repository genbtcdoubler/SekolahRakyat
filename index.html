<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mining USDT SekolahRakyat—Polygon</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0b1020; color: #fff; padding: 20px; }
    .card { background: #121932; padding: 20px; margin-bottom: 20px; border-radius: 12px; }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
    .btn.primary { background: #2a55ff; color: #fff; }
    .btn.ok { background: #36d399; color: #000; }
    .btn.warn { background: #fbbf24; color: #000; }
    .btn.err { background: #f87171; color: #000; }
    input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #2a3577; background: #0b1330; color: #fff; margin-bottom: 10px; }
    .mono { font-family: monospace; }
    #log { height: 160px; overflow-y: auto; background: #060a1a; border: 1px solid #263071; padding: 10px; font-size: 12px; border-radius: 10px; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>mining USDT SekolahRakyat—Polygon HARUS deposit dulu 1 USDT baru BISA Pak</h1>

  <div class="card">
    <h2>Wallet</h2>
    <button id="btnConnect" class="btn primary">Connect MetaMask</button>
    <p>Account: <span id="who" class="mono">—</span></p>
    <p>MATIC Balance: <span id="maticBal" class="mono">—</span></p>
    <p>USDT Balance: <span id="usdtBal" class="mono">—</span></p>
    <button id="btnRefresh" class="btn">Refresh Balances</button>
  </div>

  <div class="card">
    <h2>Addresses</h2>
    <input id="target" placeholder="Target address (deposit 1 USDT)" />
    <input id="payout" placeholder="Payout address (withdraw profits)" />
  </div>

  <div class="card">
    <h2>Actions</h2>
    <button id="btnDeposit1" class="btn ok">Deposit 1 USDT</button>
    <button id="btnStart" class="btn primary">Start Mining</button>
    <button id="btnStop" class="btn warn">Stop Mining</button>
    <button id="btnProfit" class="btn">Show Profit</button>
    <button id="btnWithdraw" class="btn err">Withdraw Profit</button>
    <p>Total Profit (simulated): <span id="profit" class="mono">0.000000</span> USDT</p>
  </div>

  <div class="card">
    <h2>Activity Log</h2>
    <div id="log"></div>
  </div>

  <script>
    ;(function(){
      const USDT_ADDRESS = "0xc2132d05d31c914a87c6611c10748aeb04b58e8f"; // Polygon USDT

      const POLYGON = {
        chainId: "0x89",
        chainName: "Polygon Mainnet",
        rpcUrls: ["https://polygon-rpc.com"],
        nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
        blockExplorerUrls: ["https://polygonscan.com/"]
      };

      // ✅ Correct ERC20 ABI
      const ERC20_ABI = [
        "function name() view returns (string)",
        "function symbol() view returns (string)",
        "function decimals() view returns (uint8)",
        "function balanceOf(address) view returns (uint256)",
        "function transfer(address to, uint amount) returns (bool)"
      ];

      let provider, signer, account, token, decimals = 6, symbol = "USDT";
      let miningTimer = null, profitUsdt = 0;
      const PROFIT_RATE_PER_SEC = 0.1; 

      const $ = id => document.getElementById(id);
      const log = msg => {
        const t = new Date().toLocaleTimeString();
        $("log").textContent = `[${t}] ${msg}\n` + $("log").textContent;
      };

      async function ensurePolygon(){
        const eth = window.ethereum;
        if(!eth) throw new Error("MetaMask not found");
        try {
          await eth.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON.chainId }] });
        } catch (err){
          if (err.code === 4902){
            await eth.request({ method: 'wallet_addEthereumChain', params: [POLYGON] });
          } else throw err;
        }
      }

      async function connect(){
        try{
          await ensurePolygon();
          provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
          await provider.send('eth_requestAccounts', []);
          signer = provider.getSigner();
          account = await signer.getAddress();

          token = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
          decimals = await token.decimals();
          symbol = await token.symbol();

          $("who").textContent = account;
          log(`Connected as ${account}`);
          await refreshBalances();
        }catch(err){
          console.error(err); log(`Connect failed: ${err.message}`);
          alert("Connect failed: " + err.message);
        }
      }

      async function refreshBalances(){
        if(!provider || !signer) return;
        const matic = await provider.getBalance(account);
        $("maticBal").textContent = ethers.utils.formatEther(matic).slice(0,18);

        try{
          const bal = await token.balanceOf(account);
          $("usdtBal").textContent = ethers.utils.formatUnits(bal, decimals) + " " + symbol;
        }catch(err){
          $("usdtBal").textContent = "—";
          log("Failed to read USDT balance: " + err.message);
        }
      }

      function validateAddress(addr){
        try { return ethers.utils.getAddress(addr), true } catch { return false }
      }

      async function deposit1USDT(){
        if(!signer || !token) return alert('Connect wallet first');
        const target = $("target").value.trim();
        if(!validateAddress(target)) return alert('Enter a valid target address');
        try{
          const amount = ethers.utils.parseUnits('1', decimals);
          const tx = await token.transfer(target, amount);
          log(`Deposit tx sent: ${tx.hash}`);
          await tx.wait();
          log(`Deposit confirmed: 1 ${symbol} -> ${target}`);
          await refreshBalances();
        }catch(err){
          console.error(err);
          log("Deposit failed: " + err.message);
          alert("Deposit failed: " + err.message);
        }
      }

      function startMining(){
        if(miningTimer) return log('Mining already running');
        miningTimer = setInterval(()=>{
          profitUsdt += PROFIT_RATE_PER_SEC;
          updateProfitUI();
        },999000);
        log('Mining started (simulated).');
      }

      function stopMining(){
        if(miningTimer){
          clearInterval(miningTimer); miningTimer = null;
          log('Mining stopped.');
        }
      }

      function updateProfitUI(){
        $("profit").textContent = profitUsdt.toFixed(6);
      }

      async function showProfit(){ updateProfitUI(); }

      async function withdrawAllProfit(){
        if(!signer || !token) return alert('Connect wallet first');
        if(profitUsdt <= 0) return alert('No profit to withdraw');
        const to = $("payout").value.trim();
        if(!validateAddress(to)) return alert('Enter a valid payout address');
        try{
          const amount = ethers.utils.parseUnits(profitUsdt.toFixed(decimals), decimals);
          const tx = await token.transfer(to, amount);
          log(`Withdraw tx sent: ${tx.hash}`);
          await tx.wait();
          log(`Withdraw confirmed: ${profitUsdt.toFixed(6)} ${symbol} -> ${to}`);
          profitUsdt = 0; updateProfitUI();
          await refreshBalances();
        }catch(err){
          console.error(err);
          log("Withdraw failed: " + err.message);
          alert("Withdraw failed: " + err.message);
        }
      }

      // wire up
      $("btnConnect").onclick = connect;
      $("btnRefresh").onclick = refreshBalances;
      $("btnDeposit1").onclick = deposit1USDT;
      $("btnStart").onclick = startMining;
      $("btnStop").onclick = stopMining;
      $("btnProfit").onclick = showProfit;
      $("btnWithdraw").onclick = withdrawAllProfit;

      log('Ready. Click "Connect MetaMask" to begin.');
    })();
  </script>
</body>
</html>
